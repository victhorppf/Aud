<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>PolarAUD - Sistema de Auditoria</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/browser-image-compression@2.0.1/dist/browser-image-compression.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/idb@7/build/umd.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        .loader { border-top-color: #3498db; -webkit-animation: spin 1s linear infinite; animation: spin 1s linear infinite; }
        @-webkit-keyframes spin { 0% { -webkit-transform: rotate(0deg); } 100% { -webkit-transform: rotate(360deg); } }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel" data-type="module">
      // Importações do Firebase
      import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
      import { 
        getAuth, 
        onAuthStateChanged,
        createUserWithEmailAndPassword,
        signInWithEmailAndPassword,
        signOut
      } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
      import { 
        getFirestore, 
        doc, 
        setDoc, 
        getDoc,
        addDoc,
        collection,
        query,
        where,
        getDocs,
        serverTimestamp,
        writeBatch,
        updateDoc,
        deleteDoc
      } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

      // =================================================================================
      // COLE AQUI A CONFIGURAÇÃO DO SEU FIREBASE
      // =================================================================================
      const firebaseConfig = {
        apiKey: "AIzaSyABacusGuCXnA3b0uLyQPKgiRXUHiqbXC8", // USE A SUA CHAVE
        authDomain: "polaraud-app.firebaseapp.com",
        projectId: "polaraud-app",
        storageBucket: "polaraud-app.appspot.com",
        messagingSenderId: "891816680442",
        appId: "1:891816680442:web:0017a9878182374b79e243",
        measurementId: "G-SQBWLWQH7K"
      };

      // =================================================================================
      // COLE AQUI A NOVA URL DA SUA API (APÓS FAZER UMA NOVA IMPLANTAÇÃO)
      // =================================================================================
      const IMAGE_API_URL = 'https://script.google.com/macros/s/AKfycbwR5r9Iv8uN0phVnsbZdv0QAuonDRwLvkGZ8j7_KuXoXgHYaODTpZ4hAmval9Jf-0R55Q/exec';

      // Inicialização do Firebase
      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);
      const db = getFirestore(app);

      // Configuração do IndexedDB
      const DBNAME = 'PolarAUD-DB';
      const STORENAME = 'auditDrafts';
      const DRAFT_KEY = 'current_audit_draft';

      async function openDb() {
        return idb.openDB(DBNAME, 1, {
          upgrade(db) {
            db.createObjectStore(STORENAME);
          },
        });
      }

      async function saveDraft(draft) {
        const db = await openDb();
        await db.put(STORENAME, draft, DRAFT_KEY);
      }

      async function loadDraft() {
        const db = await openDb();
        return db.get(STORENAME, DRAFT_KEY);
      }

      async function clearDraft() {
        const db = await openDb();
        await db.delete(STORENAME, DRAFT_KEY);
      }
      
      // Dados estáticos da aplicação
      const SECTORS = ["SESMT","CONSULTORIA", "CONFORMIDADE", "SEGURANÇA PATRIMONIAL"];
      const AUDITED_ENTITIES = ["RFB", "APPA", "MAPA", "MINISTÉRIOS DO TRABALHO", "CONPORTOS"];
      const ZONES = {
        "ZONA 1": ["PÁTIO 1", "ARMAZÉM 1", "ESCRITÓRIO 1"],
        "ZONA 2": ["PÁTIO 2", "ARMAZÉM 2", "ESCRITÓRIO 2"],
        "ZONA 3": ["PÁTIO 3", "ARMAZÉM 3", "ESCRITÓRIO 3"],
        "ZONA 4": ["PÁTIO 4", "ARMAZÉM 4", "ESCRITÓRIO 4"],
      };

      // Componente Principal
      function App() {
        const [view, setView] = React.useState('loading'); // loading, login, register, home, audit, history, viewAudit, account
        const [user, setUser] = React.useState(null);
        const [userData, setUserData] = React.useState(null);
        const [error, setError] = React.useState('');
        const [loading, setLoading] = React.useState(false);
        const [selectedAuditId, setSelectedAuditId] = React.useState(null);

        React.useEffect(() => {
          const unsubscribe = onAuthStateChanged(auth, async (currentUser) => {
            if (currentUser) {
              setUser(currentUser);
              const userDoc = await getDoc(doc(db, "users", currentUser.uid));
              if (userDoc.exists()) {
                setUserData(userDoc.data());
                setView('home');
              } else {
                setView('login');
              }
            } else {
              setUser(null);
              setUserData(null);
              setView('login');
            }
          });
          return () => unsubscribe();
        }, []);

        const handleLogout = async () => {
          await signOut(auth);
          setView('login');
        };
        
        const handleNavigate = (newView) => {
            if (newView === 'home' || newView === 'history') {
                setSelectedAuditId(null);
            }
            setView(newView);
        };

        const handleNewAudit = () => {
            setSelectedAuditId(null);
            setView('audit');
        };

        const handleContinueAudit = (auditId) => {
            setSelectedAuditId(auditId);
            setView('audit');
        };

        const handleViewAudit = (auditId) => {
            setSelectedAuditId(auditId);
            setView('viewAudit');
        };

        const renderView = () => {
          switch (view) {
            case 'loading':
              return <div className="flex justify-center items-center h-screen"><div className="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div></div>;
            case 'login':
              return <LoginPage setView={handleNavigate} setError={setError} setLoading={setLoading} />;
            case 'register':
              return <RegisterPage setView={handleNavigate} setError={setError} setLoading={setLoading} />;
            case 'home':
              return <HomePage userData={userData} setView={handleNavigate} handleLogout={handleLogout} handleNewAudit={handleNewAudit} />;
            case 'audit':
              return <AuditForm userData={userData} setView={handleNavigate} auditId={selectedAuditId} />;
            case 'history':
              return <HistoryPage userData={userData} setView={handleNavigate} onContinue={handleContinueAudit} onView={handleViewAudit} />;
            case 'account':
              return <AccountPage userData={userData} setUserData={setUserData} setView={handleNavigate} />;
            case 'viewAudit':
              return <ViewAuditPage setView={handleNavigate} auditId={selectedAuditId} />;
            default:
              return <LoginPage setView={handleNavigate} setError={setError} setLoading={setLoading} />;
          }
        };

        return (
          <div className="min-h-screen bg-gray-100">
            {loading && <div className="fixed inset-0 bg-black bg-opacity-50 flex justify-center items-center z-50"><div className="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12"></div><p className="ml-4 text-white">Processando...</p></div>}
            {error && <div className="fixed top-5 right-5 bg-red-500 text-white p-3 rounded-lg shadow-lg animate-pulse" onClick={() => setError('')}>{error}</div>}
            {renderView()}
          </div>
        );
      }
      
      // LoginPage, RegisterPage, AccountPage (sem alterações significativas)
      function LoginPage({ setView, setError, setLoading }) {
        const [email, setEmail] = React.useState('');
        const [password, setPassword] = React.useState('');

        const handleLogin = async (e) => {
            e.preventDefault();
            if (!email || !password) {
                setError("Por favor, preencha todos os campos.");
                return;
            }
            setLoading(true);
            setError('');
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (err) {
                setError("Falha no login. Verifique suas credenciais.");
                console.error(err);
            } finally {
                setLoading(false);
            }
        };

        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-50">
                <div className="w-full max-w-md p-8 space-y-6 bg-white rounded-xl shadow-lg">
                    <h1 className="text-3xl font-bold text-center text-gray-800">PolarAUD</h1>
                    <p className="text-center text-gray-500">Acesse sua conta de auditoria</p>
                    <form onSubmit={handleLogin} className="space-y-6">
                        <div>
                            <label className="text-sm font-medium text-gray-600">Email</label>
                            <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full px-4 py-2 mt-2 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="seu.email@exemplo.com" />
                        </div>
                        <div>
                            <label className="text-sm font-medium text-gray-600">Senha</label>
                            <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full px-4 py-2 mt-2 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="********" />
                        </div>
                        <button type="submit" className="w-full px-4 py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 transition-colors duration-300">Entrar</button>
                    </form>
                    <p className="text-sm text-center text-gray-500">Não tem uma conta? <button onClick={() => setView('register')} className="font-medium text-blue-600 hover:underline">Registre-se</button></p>
                </div>
            </div>
        );
      }

      function RegisterPage({ setView, setError, setLoading }) {
        const [secret, setSecret] = React.useState('');
        const [isSecretValid, setIsSecretValid] = React.useState(false);
        const [formData, setFormData] = React.useState({
            username: '',
            fullName: '',
            email: '',
            password: '',
            sector: SECTORS[0]
        });
        const SECRET_KEY = "@PolarAud@";

        const handleSecretCheck = () => {
            if (secret === SECRET_KEY) {
                setIsSecretValid(true);
                setError('');
            } else {
                setError("Segredo incorreto!");
            }
        };

        const handleChange = (e) => {
            setFormData({ ...formData, [e.target.name]: e.target.value });
        };
        
        const handleRegister = async (e) => {
            e.preventDefault();
            setLoading(true);
            setError('');
            try {
                const userCredential = await createUserWithEmailAndPassword(auth, formData.email, formData.password);
                const user = userCredential.user;
                
                await setDoc(doc(db, "users", user.uid), {
                    uid: user.uid,
                    username: formData.username,
                    fullName: formData.fullName,
                    email: formData.email,
                    sector: formData.sector,
                    role: 'auditor' // Papel padrão
                });
            } catch (err) {
                setError("Falha no registro: " + err.message);
                console.error(err);
            } finally {
                setLoading(false);
            }
        };

        if (!isSecretValid) {
            return (
                <div className="flex items-center justify-center min-h-screen bg-gray-50">
                    <div className="w-full max-w-sm p-8 space-y-4 bg-white rounded-xl shadow-lg">
                        <h2 className="text-2xl font-bold text-center text-gray-800">Acesso ao Registro</h2>
                        <p className="text-center text-gray-500">Insira o segredo para continuar.</p>
                        <input type="password" value={secret} onChange={e => setSecret(e.target.value)} className="w-full px-4 py-2 mt-2 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" placeholder="Segredo de acesso" />
                        <button onClick={handleSecretCheck} className="w-full px-4 py-3 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">Verificar</button>
                        <button onClick={() => setView('login')} className="w-full mt-2 text-center text-blue-600 hover:underline">Voltar para o Login</button>
                    </div>
                </div>
            );
        }

        return (
            <div className="flex items-center justify-center min-h-screen bg-gray-50 py-12">
                <div className="w-full max-w-lg p-8 space-y-6 bg-white rounded-xl shadow-lg">
                    <h1 className="text-3xl font-bold text-center text-gray-800">Registro de Novo Usuário</h1>
                    <form onSubmit={handleRegister} className="space-y-4">
                        <input name="username" onChange={handleChange} placeholder="Nome de usuário" className="w-full px-4 py-2 bg-gray-100 border rounded-lg" required />
                        <input name="fullName" onChange={handleChange} placeholder="Nome Completo" className="w-full px-4 py-2 bg-gray-100 border rounded-lg" required />
                        <input name="email" type="email" onChange={handleChange} placeholder="E-mail" className="w-full px-4 py-2 bg-gray-100 border rounded-lg" required />
                        <input name="password" type="password" onChange={handleChange} placeholder="Senha (mínimo 6 caracteres)" className="w-full px-4 py-2 bg-gray-100 border rounded-lg" required />
                        <select name="sector" onChange={handleChange} className="w-full px-4 py-2 bg-gray-100 border rounded-lg">
                            {SECTORS.map(s => <option key={s} value={s}>{s}</option>)}
                        </select>
                        <button type="submit" className="w-full px-4 py-3 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700">Registrar</button>
                    </form>
                     <button onClick={() => setView('login')} className="w-full mt-2 text-center text-blue-600 hover:underline">Já tenho uma conta</button>
                </div>
            </div>
        );
      }

      function AccountPage({ userData, setUserData, setView }) {
        const [fullName, setFullName] = React.useState(userData.fullName);
        const [sector, setSector] = React.useState(userData.sector);
        const [isSaving, setIsSaving] = React.useState(false);
        const [message, setMessage] = React.useState('');

        const handleSave = async () => {
            setIsSaving(true);
            setMessage('');
            try {
                const userRef = doc(db, "users", userData.uid);
                await updateDoc(userRef, {
                    fullName: fullName,
                    sector: sector
                });
                setUserData({ ...userData, fullName, sector });
                setMessage('Dados atualizados com sucesso!');
            } catch (error) {
                console.error("Erro ao atualizar dados:", error);
                setMessage('Falha ao atualizar dados.');
            } finally {
                setIsSaving(false);
            }
        };

        return (
            <div className="p-4 md:p-8 max-w-2xl mx-auto">
                <header className="flex justify-between items-center mb-6">
                    <h1 className="text-2xl font-bold text-gray-800">Minha Conta</h1>
                    <button onClick={() => setView('home')} className="px-4 py-2 text-sm font-medium text-gray-700 bg-white rounded-lg shadow-sm hover:bg-gray-50">Voltar</button>
                </header>
                <div className="bg-white p-8 rounded-xl shadow-lg space-y-6">
                    <div>
                        <label className="text-sm font-medium text-gray-600">Nome Completo</label>
                        <input type="text" value={fullName} onChange={e => setFullName(e.target.value)} className="w-full px-4 py-2 mt-2 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500" />
                    </div>
                     <div>
                        <label className="text-sm font-medium text-gray-600">Email</label>
                        <input type="email" value={userData.email} className="w-full px-4 py-2 mt-2 text-base text-gray-500 bg-gray-200 border rounded-lg" disabled />
                    </div>
                    <div>
                        <label className="text-sm font-medium text-gray-600">Setor</label>
                        <select value={sector} onChange={e => setSector(e.target.value)} className="w-full px-4 py-2 mt-2 text-base text-gray-700 bg-gray-100 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500">
                            {SECTORS.map(s => <option key={s} value={s}>{s}</option>)}
                        </select>
                    </div>
                    <div className="flex justify-end items-center">
                        {message && <p className="text-sm text-green-600 mr-4">{message}</p>}
                        <button onClick={handleSave} disabled={isSaving} className="px-6 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 disabled:bg-gray-400">
                            {isSaving ? 'Salvando...' : 'Salvar Alterações'}
                        </button>
                    </div>
                </div>
            </div>
        );
      }
      
      function HomePage({ userData, setView, handleLogout, handleNewAudit }) {
        const [showMenu, setShowMenu] = React.useState(false);
        return (
            <div className="p-4 md:p-8">
                <header className="flex justify-between items-center mb-8">
                    <h1 className="text-2xl md:text-3xl font-bold text-gray-800">PolarAUD</h1>
                    <div className="relative">
                        <button onClick={() => setShowMenu(!showMenu)} className="flex items-center space-x-2 p-2 rounded-full bg-white shadow">
                            <span className="font-medium text-gray-700 hidden md:block">{userData?.fullName}</span>
                            <i className="fas fa-user-circle text-2xl text-gray-500"></i>
                        </button>
                        {showMenu && (
                            <div className="absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-20">
                                <button onClick={() => { setView('account'); setShowMenu(false); }} className="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Ver/Editar Conta</button>
                                <button onClick={handleLogout} className="w-full text-left block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">Sair</button>
                            </div>
                        )}
                    </div>
                </header>
                <main className="bg-white p-6 rounded-xl shadow-lg">
                    <h2 className="text-xl font-semibold text-gray-700">Bem-vindo(a), {userData?.fullName}!</h2>
                    <p className="text-gray-500 mb-8">Setor: {userData?.sector}</p>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <button onClick={handleNewAudit} className="flex flex-col items-center justify-center p-8 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-transform transform hover:scale-105">
                            <i className="fas fa-plus-circle text-4xl mb-2"></i>
                            <span className="text-lg font-semibold">Iniciar Nova Auditoria</span>
                        </button>
                        <button onClick={() => setView('history')} className="flex flex-col items-center justify-center p-8 bg-gray-700 text-white rounded-lg hover:bg-gray-800 transition-transform transform hover:scale-105">
                            <i className="fas fa-history text-4xl mb-2"></i>
                            <span className="text-lg font-semibold">Histórico de Auditorias</span>
                        </button>
                    </div>
                </main>
            </div>
        );
      }

      function AuditForm({ userData, setView, auditId }) {
        const [entries, setEntries] = React.useState([]);
        const [isSaving, setIsSaving] = React.useState(false);
        const [globalError, setGlobalError] = React.useState('');

        const base64ToFile = (base64, filename, mimeType) => {
            const byteCharacters = atob(base64.split(',')[1]);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new File([byteArray], filename, { type: mimeType });
        };

        React.useEffect(() => {
            const loadInitialData = async () => {
                if (auditId) { // MODO CONTINUAR
                    setIsSaving(true);
                    try {
                        const entriesQuery = query(collection(db, "audits", auditId, "entries"));
                        const entriesSnapshot = await getDocs(entriesQuery);
                        const fetchedEntries = entriesSnapshot.docs.map(doc => ({ ...doc.data(), firestoreId: doc.id }));
                        fetchedEntries.sort((a, b) => a.entryNumber - b.entryNumber);

                        const reconstructedEntries = fetchedEntries.map(entry => ({
                            ...entry,
                            id: entry.firestoreId,
                            evidences: entry.evidenceUrls ? Object.entries(entry.evidenceUrls).map(([key, fileId]) => ({
                                type: 'remote',
                                key,
                                fileId,
                                preview: `https://drive.google.com/uc?export=view&id=${fileId}`
                            })) : []
                        }));
                        setEntries(reconstructedEntries);
                    } catch (error) {
                        setGlobalError("Erro ao carregar auditoria: " + error.message);
                    } finally {
                        setIsSaving(false);
                    }
                } else { // MODO NOVA AUDITORIA
                    const draft = await loadDraft();
                    if (draft && draft.length > 0) {
                        const restoredEntries = draft.map(entry => ({
                            ...entry,
                            evidences: entry.evidences.map(ev => ({
                                ...ev, 
                                type: 'local',
                                file: base64ToFile(ev.base64, ev.file.name, ev.file.type),
                                preview: URL.createObjectURL(base64ToFile(ev.base64, ev.file.name, ev.file.type))
                            }))
                        }));
                        setEntries(restoredEntries);
                    } else {
                        addEntry();
                    }
                }
            };
            loadInitialData();
        }, [auditId]);
        
        React.useEffect(() => {
            if (entries.length > 0 && !auditId) { // Salva rascunho apenas para novas auditorias
                const draftToSave = entries.map(entry => ({
                    ...entry,
                    evidences: entry.evidences.filter(ev => ev.type === 'local').map(ev => ({
                        base64: ev.base64, 
                        file: {name: ev.file.name, type: ev.file.type}
                    }))
                }));
                saveDraft(draftToSave);
            }
        }, [entries, auditId]);

        const addEntry = () => {
             const newEntryData = {
                id: Date.now(),
                entryNumber: entries.length + 1,
                description: '',
                complement: '',
                evidences: []
            };

            if (entries.length > 0) {
                const lastEntry = entries[entries.length - 1];
                newEntryData.auditedEntity = lastEntry.auditedEntity;
                newEntryData.operationalZone = lastEntry.operationalZone;
                newEntryData.location = lastEntry.location;
            } else {
                newEntryData.auditedEntity = AUDITED_ENTITIES[0];
                newEntryData.operationalZone = Object.keys(ZONES)[0];
                newEntryData.location = ZONES[Object.keys(ZONES)[0]][0];
            }
            setEntries([...entries, newEntryData]);
        };

        const removeEntry = (indexToRemove) => {
            if (window.confirm("Tem certeza que deseja apagar este apontamento?")) {
                const newEntries = entries.filter((_, index) => index !== indexToRemove);
                const renumberedEntries = newEntries.map((entry, index) => ({
                    ...entry,
                    entryNumber: index + 1
                }));
                setEntries(renumberedEntries);
            }
        };

        const updateEntry = (index, field, value) => {
            const newEntries = [...entries];
            newEntries[index][field] = value;
            if (field === 'operationalZone') {
                newEntries[index]['location'] = ZONES[value][0];
            }
            setEntries(newEntries);
        };

        const handleImageChange = async (index, event) => {
            const files = Array.from(event.target.files);
            if (files.length === 0) return;

            const currentEvidences = entries[index].evidences;
            if (currentEvidences.length + files.length > 3) {
                alert("Você pode adicionar no máximo 3 evidências.");
                return;
            }

            const options = {
                maxSizeMB: 0.8, // Compressão aumentada
                maxWidthOrHeight: 1024,
                useWebWorker: true
            };

            for (const file of files) {
                try {
                    const compressedFile = await imageCompression(file, options);
                    const reader = new FileReader();
                    reader.readAsDataURL(compressedFile);
                    reader.onloadend = () => {
                        const base64String = reader.result;
                        const newEvidence = {
                            type: 'local',
                            file: compressedFile,
                            base64: base64String,
                            preview: URL.createObjectURL(compressedFile)
                        };
                        
                        const newEntries = [...entries];
                        newEntries[index].evidences.push(newEvidence);
                        setEntries(newEntries);
                    };
                } catch (error) {
                    console.error("Erro na compressão:", error);
                    alert("Falha ao processar a imagem.");
                }
            }
        };

        const removeEvidence = (entryIndex, evidenceIndex) => {
            const newEntries = [...entries];
            const evidenceToRemove = newEntries[entryIndex].evidences[evidenceIndex];
            if (evidenceToRemove.type === 'local') {
                URL.revokeObjectURL(evidenceToRemove.preview);
            }
            newEntries[entryIndex].evidences.splice(evidenceIndex, 1);
            setEntries(newEntries);
        };
        
        const getTimestampString = () => {
            const d = new Date();
            const pad = (n) => n.toString().padStart(2, '0');
            return `${d.getFullYear()}${pad(d.getMonth() + 1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
        };

        const saveAudit = async () => {
            if (entries.length === 0 || entries.some(e => !e.description)) {
                setGlobalError("A auditoria precisa ter pelo menos um apontamento com descrição.");
                return;
            }
            setIsSaving(true);
            setGlobalError('');

            try {
                let currentAuditId = auditId;
                const firstEntry = entries[0];
                const summaryData = {
                    firstEntrySummary: {
                        auditedEntity: firstEntry.auditedEntity,
                        operationalZone: firstEntry.operationalZone
                    }
                };

                if (!currentAuditId) {
                    const auditData = {
                        userId: userData.uid,
                        userFullName: userData.fullName,
                        createdAt: serverTimestamp(),
                        status: "pending",
                        ...summaryData
                    };
                    const auditRef = await addDoc(collection(db, "audits"), auditData);
                    currentAuditId = auditRef.id;
                } else {
                    await updateDoc(doc(db, "audits", currentAuditId), summaryData);
                }

                const batch = writeBatch(db);
                const oldEntriesSnapshot = await getDocs(collection(db, "audits", currentAuditId, "entries"));
                oldEntriesSnapshot.forEach(doc => batch.delete(doc.ref));
                await batch.commit();
                
                const addBatch = writeBatch(db);

                for (const [index, entry] of entries.entries()) {
                    let finalEvidenceUrls = {};
                    const localImagesToUpload = entry.evidences.filter(ev => ev.type === 'local');
                    const remoteImagesToKeep = entry.evidences.filter(ev => ev.type === 'remote');

                    remoteImagesToKeep.forEach(ev => {
                        finalEvidenceUrls[ev.key] = ev.fileId;
                    });
                    
                    if (localImagesToUpload.length > 0) {
                        const imagePayload = localImagesToUpload.map((ev, localIndex) => {
                            const timestamp = getTimestampString();
                            const safeEntity = entry.auditedEntity.replace(/[^a-zA-Z0-9]/g, '');
                            const safeZone = entry.operationalZone.replace(/[^a-zA-Z0-9]/g, '');
                            const fileName = `AUD_${safeEntity}_${safeZone}_AP${entry.entryNumber}_EV${localIndex + 1}_${timestamp}`;
                            
                            return {
                                base64: ev.base64.split(',')[1],
                                mimeType: ev.file.type,
                                fileName: fileName
                            };
                        });

                        const response = await fetch(IMAGE_API_URL, {
                            method: 'POST',
                            headers: {'Content-Type': 'text/plain;charset=utf-8'},
                            body: JSON.stringify({ images: imagePayload }),
                        });

                        if (!response.ok) throw new Error(`API de imagens retornou: ${response.statusText}`);
                        const result = await response.json();
                        if (result.status !== 'success') throw new Error(`API de imagens falhou: ${result.message} ${result.stack || ''}`);
                        
                        result.files.forEach(fileInfo => {
                            finalEvidenceUrls[fileInfo.key] = fileInfo.id;
                        });
                    }

                    const entryRef = doc(collection(db, "audits", currentAuditId, "entries"));
                    addBatch.set(entryRef, {
                        entryNumber: index + 1,
                        entryTimestamp: serverTimestamp(),
                        auditedEntity: entry.auditedEntity,
                        operationalZone: entry.operationalZone,
                        technicalSector: userData.sector,
                        location: entry.location,
                        description: entry.description.toUpperCase(),
                        complement: entry.complement,
                        evidenceUrls: finalEvidenceUrls
                    });
                }
                
                await addBatch.commit();
                await clearDraft();
                alert("Auditoria salva com sucesso!");
                setView('home');

            } catch (error) {
                console.error("Erro ao salvar auditoria:", error);
                setGlobalError("Ocorreu um erro grave ao salvar. Tente novamente. Detalhes: " + error.message);
            } finally {
                setIsSaving(false);
            }
        };

        return (
            <div className="p-4 md:p-8 max-w-4xl mx-auto">
                <header className="flex justify-between items-center mb-6">
                    <h1 className="text-2xl font-bold text-gray-800">{auditId ? 'Continuar Auditoria' : 'Nova Auditoria'}</h1>
                    <button onClick={() => setView('home')} className="px-4 py-2 text-sm font-medium text-gray-700 bg-white rounded-lg shadow-sm hover:bg-gray-50">Voltar</button>
                </header>
                
                {globalError && <div className="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4" role="alert">{globalError}</div>}

                <div className="space-y-6">
                    {entries.map((entry, index) => (
                        <div key={entry.id} className="bg-white p-6 rounded-xl shadow-lg border-l-4 border-blue-500 relative">
                            <div className="flex justify-between items-center mb-4">
                                <h3 className="text-lg font-semibold text-gray-700">Apontamento #{entry.entryNumber}</h3>
                                <button onClick={() => removeEntry(index)} className="text-red-500 hover:text-red-700">
                                    <i className="fas fa-trash-alt"></i>
                                </button>
                            </div>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <input type="text" value={`Auditor: ${userData.fullName}`} className="w-full p-2 bg-gray-100 rounded-md" disabled />
                                <input type="text" value={`Setor Técnico: ${userData.sector}`} className="w-full p-2 bg-gray-100 rounded-md" disabled />
                                
                                <select value={entry.auditedEntity} onChange={e => updateEntry(index, 'auditedEntity', e.target.value)} className="w-full p-2 bg-gray-50 border rounded-md">
                                    {AUDITED_ENTITIES.map(e => <option key={e} value={e}>{e}</option>)}
                                </select>
                                <select value={entry.operationalZone} onChange={e => updateEntry(index, 'operationalZone', e.target.value)} className="w-full p-2 bg-gray-50 border rounded-md">
                                    {Object.keys(ZONES).map(z => <option key={z} value={z}>{z}</option>)}
                                </select>
                                <select value={entry.location} onChange={e => updateEntry(index, 'location', e.target.value)} className="w-full p-2 bg-gray-50 border rounded-md md:col-span-2">
                                    {ZONES[entry.operationalZone].map(l => <option key={l} value={l}>{l}</option>)}
                                </select>

                                <textarea value={entry.description} onChange={e => updateEntry(index, 'description', e.target.value)} placeholder="APONTAMENTO (EM MAIÚSCULAS)" className="w-full p-2 bg-gray-50 border rounded-md md:col-span-2 h-24 uppercase" required></textarea>
                                <textarea value={entry.complement} onChange={e => updateEntry(index, 'complement', e.target.value)} placeholder="Complemento (opcional)" className="w-full p-2 bg-gray-50 border rounded-md md:col-span-2 h-20"></textarea>
                                
                                <div className="md:col-span-2">
                                    <label className="block text-sm font-medium text-gray-700 mb-2">Evidências (até 3 imagens)</label>
                                    <input type="file" accept="image/*" multiple onChange={(e) => handleImageChange(index, e)} className="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" />
                                    <div className="mt-4 flex flex-wrap gap-4">
                                        {entry.evidences.map((ev, evIndex) => (
                                            <div key={ev.preview || evIndex} className="relative">
                                                <img src={ev.preview} className="w-24 h-24 object-cover rounded-lg shadow" />
                                                <button onClick={() => removeEvidence(index, evIndex)} className="absolute -top-2 -right-2 bg-red-500 text-white rounded-full w-6 h-6 flex items-center justify-center text-xs">&times;</button>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>

                <div className="mt-8 flex flex-col md:flex-row justify-between items-center gap-4">
                    <button onClick={addEntry} className="w-full md:w-auto px-6 py-3 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors">
                        <i className="fas fa-plus mr-2"></i> Adicionar Novo Apontamento
                    </button>
                    <button onClick={saveAudit} disabled={isSaving} className="w-full md:w-auto px-8 py-4 bg-blue-700 text-white font-bold rounded-lg hover:bg-blue-800 disabled:bg-gray-400 transition-colors text-lg">
                        {isSaving ? 'Salvando...' : 'Salvar Auditoria Completa'}
                    </button>
                </div>
            </div>
        );
      }
      
      function HistoryPage({ userData, setView, onContinue, onView }) {
        const [audits, setAudits] = React.useState([]);
        const [loading, setLoading] = React.useState(true);
        const [filter, setFilter] = React.useState('');

        const fetchAudits = async () => {
            setLoading(true);
            const q = userData.role === 'admin' 
                ? query(collection(db, "audits"))
                : query(collection(db, "audits"), where("userId", "==", userData.uid));
            
            const querySnapshot = await getDocs(q);
            const auditsData = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            auditsData.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
            setAudits(auditsData);
            setLoading(false);
        };

        React.useEffect(() => {
            fetchAudits();
        }, [userData]);
        
        const handleStatusChange = async (auditId, newStatus) => {
            if (confirm(`Tem certeza que deseja alterar o status desta auditoria para "${newStatus}"?`)) {
                const auditRef = doc(db, "audits", auditId);
                await updateDoc(auditRef, { status: newStatus });
                fetchAudits();
            }
        };

        const exportToCSV = async (auditId = null) => {
            // ... (código de exportação sem alterações)
        };

        const filteredAudits = audits.filter(audit => 
            (audit.userFullName && audit.userFullName.toLowerCase().includes(filter.toLowerCase())) ||
            (audit.id && audit.id.toLowerCase().includes(filter.toLowerCase()))
        );

        return (
            <div className="p-4 md:p-8 max-w-6xl mx-auto">
                <header className="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h1 className="text-2xl font-bold text-gray-800">Histórico de Auditorias</h1>
                    <div className="flex gap-4">
                        <button onClick={() => setView('home')} className="px-4 py-2 text-sm font-medium text-gray-700 bg-white rounded-lg shadow-sm hover:bg-gray-50">Voltar</button>
                        {userData.role === 'admin' && (
                            <button onClick={() => exportToCSV()} className="px-4 py-2 text-sm font-medium text-white bg-green-600 rounded-lg shadow-sm hover:bg-green-700">
                                <i className="fas fa-file-csv mr-2"></i> Exportar Tudo
                            </button>
                        )}
                    </div>
                </header>

                {userData.role === 'admin' && (
                    <div className="mb-6">
                        <input type="text" placeholder="Filtrar por auditor ou ID..." value={filter} onChange={e => setFilter(e.target.value)} className="w-full max-w-md p-2 border rounded-lg" />
                    </div>
                )}

                {loading ? <div className="text-center p-10">Carregando histórico...</div> : (
                    <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                        <div className="overflow-x-auto">
                            <table className="min-w-full divide-y divide-gray-200">
                                <thead className="bg-gray-50">
                                    <tr>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ID / Resumo</th>
                                        {userData.role === 'admin' && <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Auditor</th>}
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Data</th>
                                        <th className="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                        <th className="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Ações</th>
                                    </tr>
                                </thead>
                                <tbody className="bg-white divide-y divide-gray-200">
                                    {filteredAudits.length > 0 ? filteredAudits.map(audit => (
                                        <tr key={audit.id}>
                                            <td className="px-6 py-4 whitespace-nowrap text-sm">
                                                <div className="font-mono text-gray-600">{audit.id}</div>
                                                {audit.firstEntrySummary && (
                                                    <div className="text-xs text-gray-500 mt-1">
                                                        {audit.firstEntrySummary.auditedEntity} / {audit.firstEntrySummary.operationalZone}
                                                    </div>
                                                )}
                                            </td>
                                            {userData.role === 'admin' && <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{audit.userFullName}</td>}
                                            <td className="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{audit.createdAt ? new Date(audit.createdAt.seconds * 1000).toLocaleDateString('pt-BR') : 'N/A'}</td>
                                            <td className="px-6 py-4 whitespace-nowrap">
                                            <span className={`px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${audit.status === 'pending' ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}`}>
                                                {audit.status === 'pending' ? 'Pendente' : 'Concluída'}
                                            </span>
                                            </td>
                                            <td className="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                                                <div className="flex justify-end items-center gap-2">
                                                    {audit.status === 'pending' ? (
                                                        <>
                                                            <button onClick={() => onContinue(audit.id)} className="px-3 py-1 text-xs font-medium rounded-md text-blue-800 bg-blue-100 hover:bg-blue-200">Continuar</button>
                                                            {(userData.role === 'admin' || userData.uid === audit.userId) && (
                                                                <button onClick={() => handleStatusChange(audit.id, 'completed')} className="px-3 py-1 text-xs font-medium rounded-md text-green-800 bg-green-100 hover:bg-green-200">Concluir</button>
                                                            )}
                                                        </>
                                                    ) : (
                                                        <button onClick={() => onView(audit.id)} className="px-3 py-1 text-xs font-medium rounded-md text-indigo-800 bg-indigo-100 hover:bg-indigo-200">Visualizar</button>
                                                    )}
                                                    <button onClick={() => exportToCSV(audit.id)} className="px-3 py-1 text-xs font-medium rounded-md text-gray-700 bg-gray-100 hover:bg-gray-200">CSV</button>
                                                </div>
                                            </td>
                                        </tr>
                                    )) : (
                                        <tr><td colSpan="5" className="text-center py-10 text-gray-500">Nenhuma auditoria encontrada.</td></tr>
                                    )}
                                </tbody>
                            </table>
                        </div>
                    </div>
                )}
            </div>
        );
      }

      function ViewAuditPage({ setView, auditId }) {
        const [audit, setAudit] = React.useState(null);
        const [entries, setEntries] = React.useState([]);
        const [loading, setLoading] = React.useState(true);
        const [error, setError] = React.useState('');

        React.useEffect(() => {
            if (!auditId) {
                setError("Nenhuma auditoria selecionada.");
                setLoading(false);
                return;
            }
            const fetchAuditData = async () => {
                try {
                    const auditDoc = await getDoc(doc(db, "audits", auditId));
                    if (auditDoc.exists()) {
                        setAudit(auditDoc.data());
                    } else {
                        throw new Error("Auditoria não encontrada.");
                    }

                    const entriesSnapshot = await getDocs(collection(db, "audits", auditId, "entries"));
                    const entriesData = entriesSnapshot.docs.map(d => d.data());
                    entriesData.sort((a,b) => a.entryNumber - b.entryNumber);
                    setEntries(entriesData);
                } catch (e) {
                    console.error("Erro ao carregar auditoria para visualização:", e);
                    setError(e.message);
                } finally {
                    setLoading(false);
                }
            };
            fetchAuditData();
        }, [auditId]);

        if (loading) return <div className="flex justify-center items-center h-screen"><div className="loader ease-linear rounded-full border-8 border-t-8 border-gray-200 h-32 w-32"></div></div>;
        if (error) return <div className="p-8 text-center text-red-500">{error}</div>;

        return (
            <div className="p-4 md:p-8 max-w-4xl mx-auto">
                <header className="flex justify-between items-center mb-6">
                    <div>
                        <h1 className="text-2xl font-bold text-gray-800">Visualizar Auditoria</h1>
                        <p className="text-sm text-gray-500 font-mono">{auditId}</p>
                    </div>
                    <button onClick={() => setView('history')} className="px-4 py-2 text-sm font-medium text-gray-700 bg-white rounded-lg shadow-sm hover:bg-gray-50">Voltar ao Histórico</button>
                </header>
                <div className="space-y-6">
                    {entries.map((entry, index) => (
                        <div key={index} className="bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500">
                            <h3 className="text-lg font-semibold text-gray-700 mb-4">Apontamento #{entry.entryNumber}</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                                <div className="bg-gray-50 p-3 rounded-lg"><strong>Órgão:</strong> {entry.auditedEntity}</div>
                                <div className="bg-gray-50 p-3 rounded-lg"><strong>Setor Técnico:</strong> {entry.technicalSector}</div>
                                <div className="bg-gray-50 p-3 rounded-lg"><strong>Zona:</strong> {entry.operationalZone}</div>
                                <div className="bg-gray-50 p-3 rounded-lg"><strong>Local:</strong> {entry.location}</div>
                                <div className="bg-gray-50 p-3 rounded-lg md:col-span-2">
                                    <strong className="block mb-1">Apontamento:</strong>
                                    <p className="uppercase font-mono whitespace-pre-wrap">{entry.description}</p>
                                </div>
                                {entry.complement && (
                                    <div className="bg-gray-50 p-3 rounded-lg md:col-span-2">
                                        <strong className="block mb-1">Complemento:</strong>
                                        <p className="whitespace-pre-wrap">{entry.complement}</p>
                                    </div>
                                )}
                                <div className="md:col-span-2">
                                    <strong className="block mb-2">Evidências:</strong>
                                    <div className="flex flex-wrap gap-4">
                                        {entry.evidenceUrls && Object.keys(entry.evidenceUrls).length > 0 ? Object.values(entry.evidenceUrls).map((fileId, evIndex) => (
                                            <a key={evIndex} href={`https://drive.google.com/file/d/${fileId}/view`} target="_blank" rel="noopener noreferrer">
                                                <img src={`https://drive.google.com/uc?export=view&id=${fileId}`} alt={`Evidência ${evIndex + 1}`} className="w-28 h-28 object-cover rounded-lg shadow-md hover:scale-105 transition-transform" />
                                            </a>
                                        )) : <p className="text-gray-500">Nenhuma evidência fotográfica.</p>}
                                    </div>
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            </div>
        );
    }
      
      const container = document.getElementById('root');
      const root = ReactDOM.createRoot(container);
      root.render(<App />);
    </script>
</body>
</html>
